# Лабораторная работа - Политика маршрутизации в офисе Midgard

## Содержание:

1.  [Настроика политики маршрутизации для сетей офиса](#item_01)
2.  [Распределени трафика между двумя линками с провайдером](#item_02)
3.  [Настроика отслеживания линка через технологию IP SLA.(только для IPv4)](#item_03)
4.  [Настроика маршрута по-умолчанию для офиса Midgard.](#item_04)
5.  [План работы и изменения зафиксированы в документации](#item_05)

<a name="item_01"><h2>1. Настроите политику маршрутизации для сетей офиса (PBR)</h2></a>

### В чем же смысл PBR?

Обычно маршрутизатор решает, куда отправлять трафик, **только на основе адреса назначения**.  
Нам же важнот, что мы **переопределим это поведение** и зададим правило:

> «Трафик из этой офисной сети должен использовать именно один канал, а другого оффиса другой канал провайдера».

Это и есть **Policy-Based Routing (PBR)** — маршрутизация на основе политики.

---

### Зачем это нужно в Midgard

В зоне Midgard есть:

- **Офисные VLAN’ы:**
  - VLAN 10 → пользователи
  - VLAN 20 → пользователи
- **Два аплинка к провайдеру:**
  - Линия A
  - Линия B

**Без PBR:**
- Весь трафик использует **один маршрут по умолчанию**

**С PBR:**
- Можно **управлять потоком трафика для каждого VLAN отдельно**

---

### Техническая концепция (что настраивается)

PBR состоит из трёх основных элементов:

- **ACL** — определяет, какой трафик мы распознаём  
- **Route-map** — описывает политику (что делать с этим трафиком)  
- **Политика на интерфейсе** — применяет PBR к входящему трафику  

---

### Пример логики

| Сеть   | Политика              |
|-------|-----------------------|
| VLAN 10 | Линия провайдера A |
| VLAN 20 | Линия провайдера B |

В этом и есть суть **политики маршрутизации**.

---

### Важно

- PBR применяется **на входе (inbound)** на VLAN-интерфейсах маршрутизатора **R28**
- PBR **проверяется до таблицы маршрутизации**

Таким образом мы сделаем следующее:

### 1. Определим политику
  - VLAN 10 - проходит через линк А
  - VLAN 20 - проходит через линк B

![topology](image_pbr01.png)

<a name="item_02"><h2>2. Распределение трафика между двумя линками с провайдером</h2></a>

### 2. Применение этой политики на R28 испоьзуя:
  - АСL для определения VLAN траффика
  - route-map для определения next-hop для VLAN
  - использование этого route-map на входящем интерфейсе соответствующего VLAN

Конфигурация на R28

### A. Классификация оффисного траффика (ACL)
```
ip access-list extended MIDGARD_VLAN10
 permit ip 10.128.10.0 0.0.0.255 any

ip access-list extended MIDGARD_VLAN20
 permit ip 10.128.20.0 0.0.0.255 any
```
### B. Определение политика (route-map)
```
route-map MIDGARD_OFFICE_PBR permit 10
 match ip address MIDGARD_VLAN10
 set ip next-hop 10.250.130.12

route-map MIDGARD_OFFICE_PBR permit 20
 match ip address MIDGARD_VLAN20
 set ip next-hop 10.250.130.14
```
### C. Применение политики на интерфейсах каждого из VLAN

```
interface Ethernet0/2.10
 ip policy route-map MIDGARD_PBR

interface Ethernet0/2.20
 ip policy route-map MIDGARD_PBR
```


**Ping** мы делаем для теста на **loopback** интерфейс **R24 (10.52.255.24)** на обоих хостах:

![topology](image_ping01.png)

Тут важно учитывать, что для работы PBR, этой конфигурации достаточно. И мы можем это верифицировать посредтвом такой комманды:

```
show route-map MIDGARD_OFFICE_PBR

```
Мы видим, что счетчик работает каждый раз, когда мы делаем пинг на наших хостах в **vlan 10** и **vlan 20** 

![topology](image_route-map01.png)

Но как мы уже увидили выше, наш ping не проходит. В чем же дела?

А дело в том, что на обоих маршрутизаторах R25 и R26 не настроены обратные марштруты, укажывоющие на наши vlan 10 и 20 соответственно.

Мы настроим эти маршруты на обоих маршрутизаторах и посмотрим что мы получим.

На R25 мы укажем маршрут в сторону **vlan 20 (10.128.10.0/24)**, с **next-hop** адресом **R28 e0/1 - 10.250.130.13**

```
ip route 10.128.10.0 255.255.255.0 10.250.130.13
```

На R2 мы укажем маршрут в сторону **vlan 20 (10.128.20.0/24)**, с **next-hop** адресом **R28 e0/0 - 20.250.130.15**

И если мы сделаем сейчас ping на loopback на R24, то получим 



Теперь проверим через какие линки проходит траффик с наших хостов, находящихся в vlan 10 и vlan 20. 

Выполним комманду tracert c VPC30 (vlan10)

```
tracert -d 10.52.255.24
```
![topology](image_linkA.png)


Выполним комманду ту же комманду tracert теперь c VPC31 (vlan20)

```
tracert -d 10.52.255.24
```

![topology](image_linkB.png)


<a name="item_03"><h2>3. Настроика отслеживания линка через технологию IP SLA.(только для IPv4)</h2></a>



