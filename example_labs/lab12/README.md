# Фильтрация в BGP

###  Задание:

  1. Настроить маршрутизаторы ISP так, чтобы к офисам отправлялся только маршрут по-умолчанию;
  2. Пограничные маршрутизаторы принимают только маршрут по-умолчанию, но R9 принимает еще префикс от R5;
  3. Настроить маршрутизатор R18 так, чтобы R9 знал маршрут по-умолчанию и префиксы от R5;
  4. Настроить сеть ISP так, чтобы на R17 не было транзитного трафика от R19 и R18;
  5. Задокументировать все изменения.



###  Решение:

  Таблица соединений и фильтрации BGP

| ASN    | Eq  | Nbr ASN | Neighbor IP          | Filters                             |
|:-------|:----|:--------|:---------------------|-------------------------------------|
| 65301  | R1  | 65219   | 172.16.19.1          | receive only default                |
| 65301  | R1  | 65219   | 20FF:CCFF:1000:19::1 | receive only default                |
| 65305  | R5  | 65217   | 172.16.17.1          | receive only default                |
| 65305  | R5  | 65217   | 20FF:CCFF:1000:17::1 | receive only default                |
| 65309  | R9  | 65218   | 172.16.18.1          | receive default & prefix from 65305 |
| 65309  | R9  | 65218   | 20FF:CCFF:1000:18::1 | receive default & prefix from 65305 |
| 65313  | R13 | 65220   | 172.16.20.1          | receive only default                |
| 65313  | R13 | 65220   | 20FF:CCFF:1000:20::1 | receive only default                |
| 65217  | R17 | 65305   | 172.16.17.2          | send only default                   |
| 65217  | R17 | 65219   | 90.90.128.19         | send all except prefixes from 65218 |
| 65217  | R17 | 65218   | 90.90.129.18         | send all except prefixes from 65219 |
| 65217  | R17 | 65220   | 90.90.131.20         |                                     |
| 65217  | R17 | 65305   | 20FF:CCFF:1000:17::2 | send only default                   |   
| 65217  | R17 | 65219   | 20FF:CCFF:FFFF:1::19 | send all except prefixes from 65218 |
| 65217  | R17 | 65218   | 20FF:CCFF:FFFF:2::18 | send all except prefixes from 65219 |
| 65217  | R17 | 65220   | 20FF:CCFF:FFFF:5::20 |                                     |
| 65218  | R18 | 65309   | 172.16.19.2          | send default & prefix from 65305    |
| 65218  | R18 | 65219   | 90.90.131.130        |                                     |
| 65218  | R18 | 65217   | 90.90.129.17         |                                     |
| 65218  | R18 | 65220   | 90.90.130.20         |                                     |
| 65218  | R18 | 65309   | 20FF:CCFF:1000:18::2 | send default & prefix from 65305    |
| 65218  | R18 | 65219   | 20FF:CCFF:FFFF:6::19 |                                     |
| 65218  | R18 | 65217   | 20FF:CCFF:FFFF:2::17 |                                     |
| 65218  | R18 | 65220   | 20FF:CCFF:FFFF:3::20 |                                     |
| 65219  | R19 | 65301   | 172.16.19.2          | send only default                   |
| 65219  | R19 | 65217   | 90.90.128.17         |                                     |
| 65219  | R19 | 65218   | 90.90.131.129        |                                     |
| 65219  | R19 | 65220   | 90.90.130.130        |                                     |
| 65219  | R19 | 65301   | 20FF:CCFF:1000:19::2 | send only default                   |
| 65219  | R19 | 65217   | 20FF:CCFF:FFFF:1::17 |                                     |
| 65219  | R19 | 65218   | 20FF:CCFF:FFFF:6::18 |                                     |
| 65219  | R19 | 65220   | 20FF:CCFF:FFFF:4::20 |                                     |
| 65220  | R20 | 65313   | 172.16.20.2          | send only default                   |
| 65220  | R20 | 65219   | 90.90.130.129        |                                     |
| 65220  | R20 | 65218   | 90.90.130.18         |                                     |
| 65220  | R20 | 65217   | 90.90.131.17         |                                     |
| 65220  | R20 | 65313   | 20FF:CCFF:1000:20::2 | send only default                   |
| 65220  | R20 | 65219   | 20FF:CCFF:FFFF:4::19 |                                     |
| 65220  | R20 | 65218   | 20FF:CCFF:FFFF:3::18 |                                     |
| 65220  | R20 | 65217   | 20FF:CCFF:FFFF:5::17 |                                     |
  
  Не забудем понизить приоритет статической маршрутизации установив метрику статических маршрутов в 30.

  Все файлы изменений приведены [здесь](configs/).

  1. Для того, чтобы с ISP отправить клиентам только маршрут по-умолчанию, нужно:
     - Чтобы этот маршрут был;
     - Отфильтровать то, что отдаём клиенту так, чтобы ему ушел только префикс 0.0.0.0/0.

  [Пример на R19](configs/R19)


  2. Для того, чтобы от ISP принять только маршрут по-умолчанию, нужно отфильтровать то, что приходит от ISP и откинуть всё, кроме 0.0.0.0/0.

  [Пример на R13](configs/R13)


  3. Фактически, все остальные манипуляции с принятием и отправкой префиксов сводятся к составлению корректных prefix-list и навешиванием их на нужных соседей в процессе bgp.

  4. Для исключения транзитного трафика R18 и R19 через R17 нужно средствами R17 настроить фильтрацию as-path таким образом, чтобы префиксы, доступные нам через AS R18 не отдавались в сторону AS R19 и наоборот.

  [Пример на R17](configs/R17)

###  Схема фильтрации eBGP

![](bgp_filter.png)
